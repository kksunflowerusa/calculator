<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>B3å¤šä»¶åŒ…è£¹é‹è²»è¨ˆç®—æ©Ÿ</title>
<style>
  body {font-family: Arial,"Noto Sans TC",sans-serif; max-width:760px; margin:30px auto; padding:20px;}
  label {display:block; margin-top:12px;}
  input[type="number"], input[type="text"] {width:100%; padding:8px; font-size:16px; box-sizing:border-box;}
  button {margin-top:12px; padding:10px 18px; font-size:16px; border-radius:8px; cursor:pointer;}
  .result {margin-top:20px; padding:16px; border-radius:8px; background:#f7f7f7;}
  .error {color:#b00020;}
  .pkg {border:1px solid #ccc; padding:12px; margin-top:12px; border-radius:8px; background:#fafafa;}
  .muted {color:#666; font-size:13px;}
</style>
</head>
<body>
<h2>B3 å¤šä»¶åŒ…è£¹é‹è²»è¨ˆç®—æ©Ÿ</h2>

<label>ç¾åœ‹æ”¶ä»¶ Zip codeï¼ˆ5 ä½ï¼‰</label>
<input id="zip" type="text" maxlength="5" placeholder="ä¾‹å¦‚ 77084" />

<div id="packages"></div>
<button onclick="addPackage()">ï¼‹ æ–°å¢åŒ…è£¹</button>

<button onclick="calcAll()">è¨ˆç®—æ‰€æœ‰åŒ…è£¹ç¸½é‹è²»</button>

<div class="muted">è¨ˆè²»ä¾ç£… (lb) è¨ˆç®—ï¼›å°ºå¯¸å°‡è‡ªå‹•æ›ç®—æˆè‹±å‹ä¸¦å–æ•´ã€‚</div>
<div id="output" class="result" style="display:none;"></div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbz8MZ8WBqekZF8JtaEthyFDmzz6KhxtzSFXM3L8nByU_wtQaQKkM3lXGiwu9jXMw8aOtw/exec';
const FX_URL  = 'https://script.google.com/macros/s/AKfycbxIiNX4edi5eqyMPKnCnj0sohXVM9R2PtzRDSParjSHuLlT2eLwY8CQRJMzFVGsKWzq/exec';
const INTERNATIONAL_RATE = 4.69;
const SERVICE_FEE_THRESHOLD = 20;
const SERVICE_FEE = 6;

function ceil(n){ return Math.ceil(Number(n)); }

function show(msg, isErr=false){
  const out = document.getElementById('output');
  out.style.display='block';
  out.className = 'result' + (isErr?' error':'');
  out.innerHTML = msg;
}

// === å‹•æ…‹åŒ…è£¹è¼¸å…¥å€ ===
let pkgCount = 0;
function addPackage(){
  pkgCount++;
  const div = document.createElement('div');
  div.className = 'pkg';
  div.id = `pkg${pkgCount}`;
  div.innerHTML = `
    <h4>åŒ…è£¹ #${pkgCount}</h4>
    <label>é•·åº¦ï¼ˆå…¬åˆ†ï¼‰</label>
    <input type="number" step="0.1" min="0.1" id="len${pkgCount}" placeholder="ä¾‹å¦‚ 40">
    <label>å¯¬åº¦ï¼ˆå…¬åˆ†ï¼‰</label>
    <input type="number" step="0.1" min="0.1" id="wid${pkgCount}" placeholder="ä¾‹å¦‚ 30">
    <label>é«˜åº¦ï¼ˆå…¬åˆ†ï¼‰</label>
    <input type="number" step="0.1" min="0.1" id="hei${pkgCount}" placeholder="ä¾‹å¦‚ 20">
    <label>é‡é‡ï¼ˆå…¬æ–¤ï¼‰</label>
    <input type="number" step="0.1" min="0.1" id="kg${pkgCount}" placeholder="ä¾‹å¦‚ 5">
    <button onclick="removePackage(${pkgCount})" style="background:#eee; margin-top:8px;">åˆªé™¤æ­¤åŒ…è£¹</button>
  `;
  document.getElementById('packages').appendChild(div);
}

function removePackage(id){
  const el = document.getElementById(`pkg${id}`);
  if(el) el.remove();
}

// é è¨­é¡¯ç¤ºä¸€ç­†
addPackage();

async function calcAll(){
  const zip = document.getElementById('zip').value.trim();
  if(!zip || zip.replace(/\D/g,'').length!==5){
    show('è«‹è¼¸å…¥ 5 ä½æ•¸ Zip codeã€‚',true); return;
  }

  const pkgElems = document.querySelectorAll('.pkg');
  if(pkgElems.length === 0){ show('è«‹è‡³å°‘æ–°å¢ä¸€å€‹åŒ…è£¹ã€‚',true); return; }

  show('è¨ˆç®—ä¸­â€¦');

  let totalUSD = 0, totalLb = 0, details = '';
  let zoneSummary = null;

  try {
    for(let i=0;i<pkgElems.length;i++){
      const id = pkgElems[i].id.replace('pkg','');
      const len = Number(document.getElementById('len'+id).value);
      const wid = Number(document.getElementById('wid'+id).value);
      const hei = Number(document.getElementById('hei'+id).value);
      const kg  = Number(document.getElementById('kg'+id).value);
      if([len,wid,hei,kg].some(v=>!v || v<=0)){
        show(`åŒ…è£¹ #${id} çš„é•·å¯¬é«˜æˆ–é‡é‡è¼¸å…¥éŒ¯èª¤ã€‚`,true); return;
      }

      const lIn = ceil(len/2.54);
      const wIn = ceil(wid/2.54);
      const hIn = ceil(hei/2.54);
      const volWeight = ceil((lIn*wIn*hIn)/139);
      const realWeight = ceil(kg/0.454);
      const chargeWeight = Math.max(volWeight, realWeight);

      // åœ‹éš›+å°ç£è²»
      const intlFee = chargeWeight * INTERNATIONAL_RATE;
      const twFee = chargeWeight <= SERVICE_FEE_THRESHOLD ? SERVICE_FEE : 0;

      // ç¾åœ‹åœ‹å…§è²»
      const resp = await fetch(`${API_URL}?zip=${encodeURIComponent(zip)}&weight=${chargeWeight}`);
      const json = await resp.json();
      if(!json.success){ show('åœ‹å…§é‹è²»éŒ¯èª¤ï¼š'+json.message,true); return; }

      const usFee = parseFloat(String(json.rate).replace(/[^\d.]/g,'')) || 0;
      const zone = json.zone || 'æœªçŸ¥åˆ†å€';
      if(!zoneSummary) zoneSummary = zone;

      const total = intlFee + twFee + usFee;
      totalUSD += total;
      totalLb += chargeWeight;

      details += `
      <div style="margin-bottom:12px;">
        <b>åŒ…è£¹ #${id}</b><br>
        å°ºå¯¸ï¼š${lIn}Ã—${wIn}Ã—${hIn} in<br>
        æç©é‡ï¼š${volWeight} lbï½œå¯¦éš›é‡ï¼š${realWeight} lbï½œè¨ˆè²»ï¼š${chargeWeight} lb<br>
        åœ‹éš›é‹è²»ï¼š$${intlFee.toFixed(2)} ï½œ TWæœå‹™è²»ï¼š$${twFee.toFixed(2)} ï½œ åœ‹å…§ï¼š$${usFee.toFixed(2)}<br>
        å°è¨ˆï¼š<b>$${total.toFixed(2)}</b><br>
      </div>`;
    }

    // åŒ¯ç‡
    let fxRate = null;
    try{
      const fxResp = await fetch(FX_URL);
      const fxJson = await fxResp.json();
      const keys = ['rate','Rate','usdToTwd','USDTWD','twd','TWD','usdClose'];
      for(const k of keys){
        if(fxJson[k]!==undefined){
          fxRate = parseFloat(fxJson[k]);
          if(!isNaN(fxRate)) break;
        }
      }
    }catch(e){ console.warn('æŠ“åŒ¯ç‡å¤±æ•—',e); }

    const finalRate = fxRate ? (fxRate + 0.8) : null;
    const totalTWD = finalRate ? Math.ceil(totalUSD * finalRate) : 'N/A';
    const rateDisplay = finalRate ? finalRate.toFixed(3) : 'N/A';
    const today = new Date().toLocaleDateString('zh-TW');

    show(`
      <strong>B3 é‹è²»ç¸½å ±åƒ¹</strong><br/>
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>
      ${details}
      <hr>
      <b>ğŸ“¦ åŒ…è£¹ç¸½æ•¸ï¼š</b> ${pkgElems.length}<br>
      <b>ç¸½è¨ˆç£…æ•¸ï¼š</b> ${totalLb} lb<br>
      <b>ç¸½é‹è²»ï¼š</b> $${totalUSD.toFixed(2)} USD<br>
      åˆ†å€ï¼š${zoneSummary}<br><br>
      ğŸ’± å°å¹£ç¸½é‡‘é¡ï¼šç´„ NT$${totalTWD}<br>
      ä½¿ç”¨åŒ¯ç‡ï¼š1 USD = NT$${rateDisplay}<br>
      ä»Šæ—¥æ—¥æœŸï¼š${today}<br>
    `);

  } catch(err){
    show('ç™¼ç”ŸéŒ¯èª¤ï¼š'+err,true);
  }
}
</script>
</body>
</html>
