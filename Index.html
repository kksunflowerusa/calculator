<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>B3é‹è²»è¨ˆç®—æ©Ÿ2</title>
<style>
  body {font-family: Arial,"Noto Sans TC",sans-serif; max-width:720px; margin:30px auto; padding:20px;}
  label {display:block; margin-top:12px;}
  input[type="number"], input[type="text"] {width:100%; padding:8px; font-size:16px; box-sizing:border-box;}
  button {margin-top:16px; padding:10px 18px; font-size:16px; border-radius:8px; cursor:pointer;}
  .result {margin-top:20px; padding:16px; border-radius:8px; background:#f7f7f7;}
  .error {color:#b00020;}
  .muted {color:#666; font-size:13px;}
</style>
</head>
<body>
<h2>B3é‹è²»è¨ˆç®—æ©Ÿ2</h2>

<label>é•·åº¦ï¼ˆå…¬åˆ†ï¼‰</label>
<input id="lenCm" type="number" step="0.1" min="0.1" placeholder="ä¾‹å¦‚ 40" />

<label>å¯¬åº¦ï¼ˆå…¬åˆ†ï¼‰</label>
<input id="widCm" type="number" step="0.1" min="0.1" placeholder="ä¾‹å¦‚ 30" />

<label>é«˜åº¦ï¼ˆå…¬åˆ†ï¼‰</label>
<input id="heiCm" type="number" step="0.1" min="0.1" placeholder="ä¾‹å¦‚ 20" />

<label>å¯¦éš›é‡é‡ï¼ˆå…¬æ–¤ï¼‰</label>
<input id="kg" type="number" step="0.1" min="0.1" placeholder="ä¾‹å¦‚ 5" />

<label>ç¾åœ‹æ”¶ä»¶ Zip codeï¼ˆ5 ä½ï¼‰</label>
<input id="zip" type="text" maxlength="5" placeholder="ä¾‹å¦‚ 77084" />

<button onclick="calcAll()">è¨ˆç®—ç¸½é‹è²»</button>

<div class="muted">è¨ˆè²»ä¾ç£… (lb) è¨ˆç®—ï¼›å°ºå¯¸å°‡è‡ªå‹•æ›ç®—æˆè‹±å‹ä¸¦å–æ•´ã€‚</div>
<div id="output" class="result" style="display:none;"></div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbz8MZ8WBqekZF8JtaEthyFDmzz6KhxtzSFXM3L8nByU_wtQaQKkM3lXGiwu9jXMw8aOtw/exec'; // â†æ”¹æˆå¯¦éš›éƒ¨ç½²çš„ Apps Script URL
const FX_URL  = 'https://script.google.com/macros/s/AKfycbxIiNX4edi5eqyMPKnCnj0sohXVM9R2PtzRDSParjSHuLlT2eLwY8CQRJMzFVGsKWzq/exec'; // æŠ“å–å³æ™‚åŒ¯ç‡
const INTERNATIONAL_RATE = 3.99; // USD per lb
const SERVICE_FEE_THRESHOLD = 20; // lb
const SERVICE_FEE = 6; // USD

function show(msg, isErr=false){
  const out = document.getElementById('output');
  out.style.display='block';
  out.className = 'result' + (isErr?' error':'');
  out.innerHTML = msg;
}
function ceil(n){ return Math.ceil(Number(n)); }

// å˜—è©¦å¾ JSON ç‰©ä»¶ä¸­æ‰¾å‡ºåˆç†åŒ¯ç‡
function findRateInObj(obj) {
  if (!obj) return null;
  const keys = ['usdCashSell','usdSell','cashSell','sell','rate','exchangeRate','usd_to_twd','usdtotwd','usdToTwd','USDTWD','TWD','twd'];
  for (const k of Object.keys(obj)) {
    for (const c of keys) {
      if (k.toLowerCase() === c.toLowerCase()) {
        const v = parseFloat(obj[k]);
        if (Number.isFinite(v) && v>1 && v<200) return v;
      }
    }
  }
  if (obj.rates && obj.rates.TWD) {
    const v = parseFloat(obj.rates.TWD);
    if (Number.isFinite(v) && v>1 && v<200) return v;
  }
  return null;
}

async function calcAll(){
  const len = Number(document.getElementById('lenCm').value);
  const wid = Number(document.getElementById('widCm').value);
  const hei = Number(document.getElementById('heiCm').value);
  const kg  = Number(document.getElementById('kg').value);
  const zip = document.getElementById('zip').value.trim();

  if([len,wid,hei,kg].some(v=>!v || v<=0)){
    show('è«‹è¼¸å…¥æ­£ç¢ºçš„é•·å¯¬é«˜èˆ‡é‡é‡ï¼ˆçš†éœ€å¤§æ–¼ 0ï¼‰ã€‚',true); return;
  }
  if(!zip || zip.replace(/\D/g,'').length!==5){
    show('è«‹è¼¸å…¥ 5 ä½æ•¸ Zip codeã€‚',true); return;
  }

  // ---- 1ï¸âƒ£ è¨ˆç®—æç©é‡èˆ‡å¯¦éš›é‡é‡ ----
  const lIn = ceil(len/2.54);
  const wIn = ceil(wid/2.54);
  const hIn = ceil(hei/2.54);
  const volWeight = ceil((lIn * wIn * hIn)/139);
  const realWeight = ceil(kg / 0.454);
  const chargeWeight = Math.max(volWeight, realWeight);

  const intlFee = chargeWeight * INTERNATIONAL_RATE;
  const twFee = chargeWeight <= SERVICE_FEE_THRESHOLD ? SERVICE_FEE : 0;

  show('è¨ˆç®—ä¸­â€¦');

  try {
    // 2ï¸âƒ£ å–å¾—ç¾åœ‹åœ‹å…§é‹è²»
    const resp = await fetch(`${API_URL}?zip=${encodeURIComponent(zip)}&weight=${chargeWeight}`);
    const data = await resp.json();
    if(!data.success) { show('åœ‹å…§é‹è²»éŒ¯èª¤ï¼š'+data.message,true); return; }

    const usFee = parseFloat(String(data.rate).toString().replace(/[^\d.]/g,''));
    if(isNaN(usFee)){ show('åœ‹å…§é‹è²»æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥è©¦ç®—è¡¨æ•¸æ“šã€‚',true); return; }

    const totalUsd = intlFee + twFee + usFee;

    // 3ï¸âƒ£ æŠ“å–å³æ™‚å°å¹£åŒ¯ç‡ä¸¦åŠ  0.8
    let twdRate = null;
    try {
      const fxResp = await fetch(FX_URL, {cache:'no-cache'});
      const fxText = await fxResp.text();
      let fxJson;
      try { fxJson = JSON.parse(fxText); } catch {}
      const baseRate = fxJson ? findRateInObj(fxJson) : (() => {
        const m = fxText.match(/([0-9]+(?:\.[0-9]+)?)/g);
        if (m) {
          for (const x of m) {
            const v = parseFloat(x);
            if (v > 1 && v < 200) return v;
          }
        }
        return null;
      })();
      if (baseRate) twdRate = baseRate + 0.8;
    } catch(e){ console.error('åŒ¯ç‡æŠ“å–å¤±æ•—', e); }

    const twdTotal = twdRate ? Math.ceil(totalUsd * twdRate) : 'N/A';
    const rateDisplay = twdRate ? twdRate.toFixed(3) : 'N/A';
    const today = new Date().toLocaleDateString('zh-TW', { year:'numeric', month:'2-digit', day:'2-digit' });

    // 4ï¸âƒ£ é¡¯ç¤ºçµæœ
    show(`
      <strong>è¨ˆç®—çµæœ</strong><br/>
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>
      æç©é‡ï¼š${volWeight} lb<br/>
      å¯¦éš›é‡ï¼š${realWeight} lb<br/>
      <b>è¨ˆè²»ç£…æ•¸ï¼š${chargeWeight} lb</b><br/><br/>
      1ï¸âƒ£ åœ‹éš›é‹è²»ï¼š$${intlFee.toFixed(2)}<br/>
      2ï¸âƒ£ TW æœå‹™è²»(<=20ç£…)ï¼š$${twFee.toFixed(2)}<br/>
      3ï¸âƒ£ ç¾åœ‹åœ‹å…§é‹è²»ï¼š$${usFee.toFixed(2)}<br/>
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>
      <b>ç¸½é‹è²»ï¼š$${totalUsd.toFixed(2)}</b><br/><br/>
      ğŸ’° ä»¥åŒ¯ç‡è¨ˆç®—ï¼šNT$${twdTotal}<br/>
      ä½¿ç”¨åŒ¯ç‡ï¼š1 USD = NT$${rateDisplay}<br/>
      ä»Šæ—¥æ—¥æœŸï¼š${today}
    `);
  } catch(err){
    show('ç™¼ç”ŸéŒ¯èª¤ï¼š'+err,true);
  }
}
</script>
</body>
</html>

